---
name: figma-widget-pipeline-orchestration
description: Оркестрирует конвейер переноса виджетов из Figma (analyst → engineer[] → judge-logic[] → ui-creator[] → judge-ui[]). Запускает инженеров и UI создателей параллельно — по одному агенту на виджет. Используй при запросе "перенеси виджеты из Figma" или при передаче Figma node URL.
---

# Оркестрация конвейера Figma → виджеты

## Структура конвейера

```
Пользователь передаёт Figma node URL
              ↓
figma-widget-analyst     → widgets_list.md + <slug>/widget_analysis.md (для каждого виджета)
              ↓
[ПАРАЛЛЕЛЬНО] figma-widget-engineer × N     → engineer_output.md + файлы виджета
              ↓
[ПАРАЛЛЕЛЬНО] figma-widget-judge-logic × N  → judge_logic_output.md
              ↓ (если НЕ ПРОШЁЛ — повторить engineer → judge-logic до ПРОШЁЛ)
[ПАРАЛЛЕЛЬНО] figma-widget-ui-creator × N   → ui_creator_output.md + views/default.tsx
              ↓
[ПАРАЛЛЕЛЬНО] figma-widget-judge-ui × N     → judge_ui_output.md
              ↓ (если НЕ ПРОШЁЛ — повторить ui-creator → judge-ui до ПРОШЁЛ)
              ✅ Все виджеты перенесены
```

## Параллельный запуск — как это работает технически

**Параллельный запуск в Cursor = несколько вызовов Task в ОДНОМ ответе агента.**

Если ты делаешь по одному Task-вызову за раз и ждёшь ответа между ними — это **последовательно**.
Чтобы запустить N агентов по-настоящему параллельно — эмитируй все N вызовов Task в **одном сообщении**:

```
← один ответ агента содержит:
  Task(engineer, widget-1)
  Task(engineer, widget-2)
  Task(engineer, widget-3)
← все три запущены параллельно
```

Не пиши "сейчас запущу Widget-1, потом Widget-2" — это последовательный запуск.
Запускай все сразу: один ответ → несколько Task-блоков.

## Главное правило — не передавать контекст вручную

Не собирай содержимое файлов и не пересылай его агентам.
Каждый агент сам читает нужные файлы из своей папки задачи.
Твоя роль — вызвать агента и передать путь к папке задачи.

**Единственное исключение:** аналитику передаются Figma URL напрямую.
После аналитика — используй список виджетов из его ответного сообщения.

## Что передавать каждому агенту

| Агент | Что передавать |
|-------|----------------|
| figma-widget-analyst | Figma node URL (напрямую от пользователя) |
| figma-widget-engineer | Только путь к папке задачи виджета |
| figma-widget-judge-logic | Только путь к папке задачи виджета |
| figma-widget-ui-creator | Только путь к папке задачи виджета |
| figma-widget-judge-ui | Только путь к папке задачи виджета |

Не читай `.md` файлы. Не пересказывай их агентам. Каждый агент знает что читать.

## Типы субагентов

Все агенты запускаются с `subagent_type="generalPurpose"`.

## Использование браузера и Figma MCP

Figma читается через **Figma Desktop MCP** (`user-figma-desktop`) — это не браузер,
параллельные вызовы безопасны.

Браузер (`cursor-ide-browser`) нужен только для **Storybook**. Браузер общий с `browser_lock` —
параллельные агенты конкурируют за него.

| Агент | Figma MCP | Браузер (Storybook) | Режим запуска |
|-------|----------|---------------------|--------------|
| figma-widget-analyst | ✅ | ❌ | **Параллельно** (один агент на все ноды) |
| figma-widget-engineer | ❌ | ❌ | **Параллельно** |
| figma-widget-judge-logic | ❌ | ❌ | **Параллельно** |
| figma-widget-ui-creator | ✅ | ✅ Storybook | **Последовательно** |
| figma-widget-judge-ui | ✅ | ✅ Storybook | **Последовательно** |

## Алгоритм шаг за шагом

### Шаг 1 — Аналитик (один раз)

Запусти `figma-widget-analyst`, передав Figma node URL.

Дождись завершения. Аналитик в ответном сообщении выдаст список виджетов и их папки задач:
```
1. Order Status Card → ai/tasks/figma-<batch>/order-status-card/
2. KPI Summary → ai/tasks/figma-<batch>/kpi-summary/
```

Зафиксируй этот список — он нужен для запуска агентов.

---

### Шаг 2 — Инженеры (параллельно, по одному на виджет)

Запусти N субагентов `figma-widget-engineer` одновременно.
Каждому передай путь к папке его виджета.

Дождись завершения ВСЕХ инженеров.

---

### Шаг 3 — Судьи логики (параллельно, по одному на виджет)

Запусти N субагентов `figma-widget-judge-logic` одновременно.
Каждому передай путь к папке его виджета.

Дождись завершения ВСЕХ судей.

---

### Шаг 4 — Цикл исправления логики (если нужен)

Для каждого виджета где судья вернул `❌ НЕ ПРОШЁЛ`:
- Повторно запусти `figma-widget-engineer` с тем же путём к папке задачи
- Он прочитает `judge_logic_output.md` сам и исправит замечания
- После чего запусти `figma-widget-judge-logic` снова

Повторяй до тех пор, пока все виджеты не получат `✅ ПРОШЁЛ`.

**Лимит итераций: 3.** Если после 3 итераций виджет не прошёл — сообщи пользователю и остановись.

---

### Шаг 5 — UI создатели (последовательно, по одному на виджет)

⚠️ **UI создатели запускаются последовательно** — они работают с браузером (Storybook + Figma),
и параллельный запуск приведёт к конфликту за браузерный лок.

Запускай субагентов `figma-widget-ui-creator` по одному, дожидаясь завершения каждого
перед запуском следующего. Каждому передай путь к папке его виджета.

---

### Шаг 6 — Судьи UI (последовательно, по одному на виджет)

⚠️ **Судьи UI запускаются последовательно** — та же причина: браузер (Storybook + Figma).

Запускай субагентов `figma-widget-judge-ui` по одному. Каждому передай путь к папке его виджета.

---

### Шаг 7 — Цикл исправления UI (если нужен)

Для каждого виджета где судья вернул `❌ НЕ ПРОШЁЛ`:
- Повторно запусти `figma-widget-ui-creator` с тем же путём к папке задачи
- Он прочитает `judge_ui_output.md` сам и исправит замечания
- После чего запусти `figma-widget-judge-ui` снова

Повторяй до тех пор, пока все виджеты не получат `✅ ПРОШЁЛ`.

**Лимит итераций: 5** (UI перенос сложнее, больше итераций). Если после 5 итераций виджет не прошёл — сообщи пользователю с деталями оставшихся нарушений.

---

## Формат сообщений пользователю

**После аналитика:**
```
✅ Аналитик завершил работу
Найдено виджетов: N
Запускаю инженеров параллельно...
```

**После всех инженеров:**
```
✅ Все инженеры завершили работу (N/N)
Запускаю судей логики...
```

**После судей логики (все прошли):**
```
✅ Логика проверена — все N виджетов прошли
Запускаю UI создателей параллельно...
```

**После судей логики (есть нарушения):**
```
⚠️ Судьи логики завершили: N прошли, M не прошли
Повторяю инженеров для: <slug-1>, <slug-2>... (итерация 2)
```

**После всех UI создателей:**
```
✅ UI создатели завершили работу (N/N) [последовательно]
Запускаю судей UI последовательно...
```

**После судей UI (все прошли):**
```
✅ Все N виджетов перенесены из Figma!

Список виджетов:
- <Widget Name> → frontend/src/widgets/instances/<slug>/
- ...
```

**При достижении лимита итераций:**
```
⚠️ Лимит итераций достигнут для виджета <Widget Name>
Последние нарушения: [вставь из judge_output.md — раздел "Итог"]
Требуется ручное вмешательство.
```

## Запуск конкретного шага (частичный запуск)

Если пользователь хочет запустить только часть конвейера — запускай только то что он просит.

| Команда | Что запускать |
|---------|--------------|
| "запусти аналитика" | Только Шаг 1 |
| "запусти инженеров" | Только Шаг 2-4 |
| "запусти UI создателей" | Только Шаг 5-7 |
| "проверь логику" | Только Шаг 3 |
| "проверь UI" | Только Шаг 6 |
| "запусти весь конвейер" | Шаги 1-7 последовательно |

## Что является командой продолжить

✅ "запусти весь конвейер", "перенеси виджеты из Figma", "продолжай"

❌ Молчание — не команда  
❌ Завершение предыдущего агента само по себе — не команда (кроме автоматических циклов исправления)

**Исключение: циклы исправления** — если судья вернул ❌, повторный запуск инженера/UI создателя выполняется автоматически без ожидания команды пользователя.
